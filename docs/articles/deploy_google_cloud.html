<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deploy: Google Cloud • maplandscape</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Deploy: Google Cloud">
<meta property="og:description" content="maplandscape">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">maplandscape</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/add_columns.html">Add Columns</a>
    </li>
    <li>
      <a href="../articles/admin_mode.html">Admin Mode</a>
    </li>
    <li>
      <a href="../articles/charts.html">Charts</a>
    </li>
    <li>
      <a href="../articles/deploy_google_cloud.html">Deploy: Google Cloud</a>
    </li>
    <li>
      <a href="../articles/exploring-cropping-systems.html">Exploring Cropping Systems</a>
    </li>
    <li>
      <a href="../articles/filter_rows.html">Filter Rows</a>
    </li>
    <li>
      <a href="../articles/group_by_summarise.html">Summary Tables</a>
    </li>
    <li>
      <a href="../articles/oauth.html">OAuth2.0 setup</a>
    </li>
    <li>
      <a href="../articles/spatial_join.html">Combine Spatial Layers</a>
    </li>
    <li>
      <a href="../articles/web_mapping.html">Web Mapping</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/livelihoods-and-landscapes/maplandscape/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="deploy_google_cloud_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Deploy: Google Cloud</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/livelihoods-and-landscapes/maplandscape/blob/master/vignettes/deploy_google_cloud.Rmd"><code>vignettes/deploy_google_cloud.Rmd</code></a></small>
      <div class="hidden name"><code>deploy_google_cloud.Rmd</code></div>

    </div>

    
    
<p>This vignette provides a set of instructions for deploying maplandscape on <a href="https://cloud.google.com/run">Google Cloud Run</a>. Google Cloud Run provides pay-per-use services for deploying containerised applications; this means you are only billed when the application is running.</p>
<p>Shiny apps can be deployed as containerised applications on Google Cloud Run with some configuration.</p>
<div id="build-maplandscape-as-a-docker-image" class="section level2">
<h2 class="hasAnchor">
<a href="#build-maplandscape-as-a-docker-image" class="anchor"></a>Build maplandscape as a docker image</h2>
<p>Clone the maplandscape GitHub repo:</p>
<pre><code>git clone https://github.com/livelihoods-and-landscapes/maplandscape.git

cd maplandscape/inst/docker</code></pre>
<p>There is a sub-directory named <code>inst/docker</code>. This contains a <code>Dockerfile</code> that lists instructions that are used to build a docker image.</p>
<pre><code>docker build -t maplandscape .</code></pre>
<p>The image is based on the <code>rocker/shiny:latest</code> image which includes <a href="https://www.rstudio.com/products/shiny/shiny-server/?_ga=2.240850435.1437924050.1628840494-908324396.1627896044">Shiny Server</a> to host the maplandscape Shiny application. Shiny Server serves apps out of the <code>srv/shiny-server/</code> directory; building the docker image will install all the R packages required to run maplandscape, install the maplandscape package from github, and copy an <code>app.R</code> script into <code>srv/shiny-server/app</code> which contains the commands to launch maplandscape.</p>
<p>A customised <code>shiny-customised.config</code> file is used to set the <code>app_dir</code> to the app directory where Shiny Server will launch and serve the app from.</p>
</div>
<div id="deploy-a-shiny-application-on-google-cloud-run" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-shiny-application-on-google-cloud-run" class="anchor"></a>Deploy a Shiny application on Google Cloud Run</h2>
<p>While Google Cloud Run supports WebSockets, it is stateless, does not provide <a href="https://cloud.google.com/run/docs/triggering/websockets#sticky-sessions">session affinity or sticky sessions</a>, and it is possible that user requests could be routed different container instances of Shiny applications. Thus, user requests could be routed to a different container instance than the one which stores their <a href="https://github.com/rstudio/shiny/issues/2455#issuecomment-497883381">session in memory</a>. To sidestep this issue, when deploying a containerised Shiny app on Google Cloud Run the service can be configured to limit the number of container instances to one. This ensures that user’s requests are always routed to the same Shiny app instance. The trade-off with this approach is that the app won’t dynamically scale if it receives more traffic than one instance can handle. is possible to use higher CPU / RAM for a single container so it can better handle more traffic.</p>
<p>It is also necessary to disable some WebSocket protocols in Shiny Server that do not work with Google Cloud Run (see <a href="https://github.com/randy3k/shiny-cloudrun-demo">here</a> for an example). The <code>shiny-customized.config</code> file in the <code>docker</code> directory of this package can be used to overwrite default shiny server configurations and disable WebSocket features not supported by Google Cloud Run. When building the docker image this file can be copied to <code>/etc/shiny-server/shiny-server.conf</code> as specified in the <code>Dockerfile</code>.</p>
<p>Setup a Google Cloud project and ensure <a href="https://cloud.google.com/billing/docs/how-to/modify-project">billing is enabled</a>.</p>
<p>Install the <a href="https://cloud.google.com/sdk/docs/install">Google Cloud SDK</a> and initialise it:</p>
<pre><code>gcloud init</code></pre>
<p>Enable Google Container Registry:</p>
<pre><code>gcloud services enable containerregistry.googleapis.com</code></pre>
<p>Configure docker to work with Google Cloud and allow the docker client to make authenticated requests to <a href="https://github.com/GoogleCloudPlatform/docker-credential-gcr">Google Container Registry</a>.</p>
<pre><code>google auth configure-docker</code></pre>
<p>Rename the image tag with a reference to a Google Container Registry image:</p>
<pre><code>docker tag &lt;tag name&gt; gcr.io/&lt;gcs project id&gt;/&lt;image name&gt;</code></pre>
<p>Push image to Google Container Registry:</p>
<pre><code>docker push gcr.io./&lt;project-id&gt;/&lt;image-name&gt;</code></pre>
<p>Deploy the containerised Shiny app on Google Cloud Run using <code>gcloud</code> command line tools:</p>
<pre><code>gcloud run deploy &lt;service name&gt; --image gcr.io/&lt;gcs project id&gt;/&lt;image name&gt; --platform managed --port 3838 --memory 2Gi  --allow-unauthenticated --cpu 1 --max-instances 1
</code></pre>
<p>Use the <code>--allow-unauthenticaed</code> flag to make the app public and allow it to be launched by unauthenticated users.</p>
<p>Set the <code>--max-instances 1</code> flag to ensure only Google Cloud Run only launches one Shiny instance.</p>
</div>
<div id="further-reading" class="section level2">
<h2 class="hasAnchor">
<a href="#further-reading" class="anchor"></a>Further Reading</h2>
<p>Shiny on Google Cloud Run - Scale-to-Zero R Web Apps: <a href="https://code.markedmondson.me/shiny-cloudrun/" class="uri">https://code.markedmondson.me/shiny-cloudrun/</a></p>
<p>Outstanding User Interfaces with Shiny - Chapters 5 and 11 provide an excellent overview of client-server concepts from a Shiny application perspective - <a href="https://unleash-shiny.rinterface.com/shiny-intro.html" class="uri">https://unleash-shiny.rinterface.com/shiny-intro.html</a></p>
<p>Deploying containerised applications on Google Cloud Run - <a href="https://cloud.google.com/run/docs/deploying#command-line" class="uri">https://cloud.google.com/run/docs/deploying#command-line</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Duncan, Kevin Davies.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
