<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OAuth2.0 setup • maplandscape</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="OAuth2.0 setup">
<meta property="og:description" content="maplandscape">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">maplandscape</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/add_columns.html">Add Columns</a>
    </li>
    <li>
      <a href="../articles/admin_mode.html">Admin Mode</a>
    </li>
    <li>
      <a href="../articles/charts.html">Charts</a>
    </li>
    <li>
      <a href="../articles/deploy_google_cloud.html">Deploy: Google Cloud</a>
    </li>
    <li>
      <a href="../articles/exploring-cropping-systems.html">Exploring Cropping Systems</a>
    </li>
    <li>
      <a href="../articles/filter_rows.html">Filter Rows</a>
    </li>
    <li>
      <a href="../articles/group_by_summarise.html">Summary Tables</a>
    </li>
    <li>
      <a href="../articles/oauth.html">OAuth2.0 setup</a>
    </li>
    <li>
      <a href="../articles/spatial_join.html">Combine Spatial Layers</a>
    </li>
    <li>
      <a href="../articles/web_mapping.html">Web Mapping</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/livelihoods-and-landscapes/maplandscape/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="oauth_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>OAuth2.0 setup</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/livelihoods-and-landscapes/maplandscape/blob/master/vignettes/oauth.Rmd"><code>vignettes/oauth.Rmd</code></a></small>
      <div class="hidden name"><code>oauth.Rmd</code></div>

    </div>

    
    
<div id="oauth2-0-on-google-cloud" class="section level2">
<h2 class="hasAnchor">
<a href="#oauth2-0-on-google-cloud" class="anchor"></a>OAuth2.0 on Google Cloud</h2>
<p>This vignette demonstrates how you can make authenticated requests to query and retrieve objects from Google Cloud Storage from a Shiny application and sets you up to use functions provided in maplandscape for listing Google Cloud Storage buckets, listing objects in Google Cloud Storage buckets, and downloading (GETting) objects from a Google Cloud Storage bucket into your app instance. Google Cloud Storage APIs use <a href="https://developers.google.com/identity/protocols/oauth2#basicsteps">OAuth2.0</a> for authentication</p>
<div id="create-oauth2-0-authorisation-credentials" class="section level3">
<h3 class="hasAnchor">
<a href="#create-oauth2-0-authorisation-credentials" class="anchor"></a>Create OAuth2.0 Authorisation Credentials</h3>
<p>The first stage of making authenticated requests to Google Cloud Storage APIs from a Shiny application is generating authorisation credentials used to identify the application to Google authentication servers. Read more <a href="https://developers.google.com/identity/protocols/oauth2/web-server#creatingcred">here</a>.</p>
<p>Navigate to <em>APIs and services</em> in the Google Cloud Platform menu. Select <em>OAuth consent screen</em> and fill out the required information.</p>
<p><img src="go-to-api-services.png" width="40%" height="auto" style="display: block; margin-left: auto; margin-right: auto; padding: 5px; border: thin silver solid;"></p>
<p>You will need to select <em>Cloud Storage API</em> as a sensitive scope. This will allow users to make authenticated requests to their Google Cloud Storage buckets and objects.</p>
<p>If the app is in-development or testing phases, you can add test users.</p>
<p><img src="test-users.png" width="40%" height="auto" style="display: block; margin-left: auto; margin-right: auto; padding: 5px; border: thin silver solid;"></p>
<p>If you want to publish the app you will need to get it verified by Google (read more about this process <a href="https://support.google.com/cloud/answer/9110914#">here</a>).</p>
<p><img src="publish-app.png" width="40%" height="auto" style="display: block; margin-left: auto; margin-right: auto; padding: 5px; border: thin silver solid;"></p>
<p>Next, head to the <em>Credentials</em> section and click <em>Create Credentials</em> and <em>OAuth client ID</em>.</p>
<p><img src="create-credentials.png" width="40%" height="auto" style="display: block; margin-left: auto; margin-right: auto; padding: 5px; border: thin silver solid;"></p>
<p>Select Application type as <em>Web application</em> and add URI (<em>Authorised redirect URIs</em>) for where you want authourised users to be redirected to (typically, an instance of a Shiny app where they can interact with their GeoPackages in Google Cloud Storage).</p>
<p><img src="create-web-application.png" width="40%" height="auto" style="display: block; margin-left: auto; margin-right: auto; padding: 5px; border: thin silver solid;"></p>
</div>
</div>
<div id="httr-oauth_app" class="section level2">
<h2 class="hasAnchor">
<a href="#httr-oauth_app" class="anchor"></a>HTTR OAuth_app</h2>
<p>Once you create your OAuth client, you will see that a Client ID and a Client Secret have been generated and you can use these to create an <a href="https://httr.r-lib.org/reference/oauth_app.html">OAuth app</a>. This will allow users to authenticate themselves using their Google identity (e.g. a gmail account) and make authenticated requests to their Google Cloud Storage.</p>
<p>Head to the directory where you cloned the <code>maplandscape</code> package.</p>
<pre><code>git clone https://github.com/livelihoods-and-landscapes/maplandscape.git

cd maplandscape</code></pre>
<p>Navigate to the app directory at:</p>
<pre><code>cd inst/app/</code></pre>
<p>Create a <a href="https://rstudio.github.io/config/index.html">config</a> file to store your Client ID, Client Secret, and redirect URI using the following template:</p>
<pre><code>touch config.yml</code></pre>
<pre><code>default:
  oauth_key: "&lt;Client ID here&gt;"
  oauth_secret: "&lt;Client Secret here&gt;"
  app_url: "&lt;redirect URL here&gt;"</code></pre>
<p>If you want to keep your Client ID and Client Secret private you can include the <code>config.yml</code> file in <code>.gitignore</code> when using version control and public remote repositories.</p>
<p>When you launch your app, the following code in the <code>inst/app/global.R</code> will be executed, reading the variables specified in the config.yml file, and creating an OAuth app that you can use within your Shiny app.</p>
<pre><code>app &lt;- httr::oauth_app("shiny",
                       key = config::get("oauth_key"),
                       secret = config::get("oauth_secret"),
                       redirect_uri = APP_URL
)</code></pre>
<p>You can use this app with <a href="https://httr.r-lib.org/reference/oauth2.0_token.html">httr’s</a> <code>oauth2.0_token()</code> to retrieve a <code>token2.0()</code> object which will allow the Shiny app to make requests to the Google Cloud Storage API’s on behalf of the authenticated user. An example of this process can be seen <a href="https://gist.github.com/hadley/144c406871768d0cbe66b0b810160528">here</a> (a minimal example) and in this snipped taken from <code>inst/app/server.R</code>:</p>
<pre><code>  ## Get token that can be used to make authenticated requests to Google Cloud Storage
  token &lt;- reactive({

    ## gets all the parameters in the URL. The auth code should be one of them.
    pars &lt;- shiny::parseQueryString(session$clientData$url_search)

    if (length(pars$code) &gt; 0) {
      ## extract the authorization code
      # Manually create a token
      token &lt;- try(
        httr::oauth2.0_token(
          app = app,
          endpoint = api,
          credentials = httr::oauth2.0_access_token(api, app, pars$code),
          cache = TRUE
        )
      )
      if ("try-error" %in% class(token)) {
        token &lt;- NULL
      }
    } else {
      token &lt;- NULL
    }

    token
  })</code></pre>
<p>This generates a reactive object <code>token</code> which either has the value <code>NULL</code> when a user has not authenticated themselves to Google Cloud Storage and received an OAuth token or a value of a <code>token2.0()</code> object if authentication has been successful. Following successful authentication of a user to the Google Cloud Storage API, token can be included in HTTP requests to Google Cloud Storage API’s to query or retrieve items in Google Cloud Storage buckets. This package provides functions to list and get objects from Google Cloud Storage:</p>
<ul>
<li>
<code>list_gcs_buckets</code> - list all buckets in Google Cloud project.</li>
<li>
<code>list_gcs_bucket_objects</code> - lists all objects in a Google Cloud Storage bucket.</li>
<li>
<code>get_gcs_object</code> - gets an object from a Google Cloud Storage bucket.</li>
</ul>
<p>A full list of Google Cloud Storage API methods, which can be used for interacting with Google Cloud Storage buckets and objects via HTTP requests, are listed <a href="https://cloud.google.com/storage/docs/json_api/v1/objects#methods">here</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Duncan, Kevin Davies.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
